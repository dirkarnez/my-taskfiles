version: '3'

tasks:
  default:
    deps:
      - task: parallel-download-task
        vars:
          URLS:
            ref: .URLS
    vars:
      FIRST_FILE_NAME:
        sh: curl --head --remote-name --write-out %{filename_effective} {{ index .URLS 0 }}
    requires:
      vars: [URLS]
    cmds:
      - echo "unzipping"
      - 7z.exe x {{ .FIRST_FILE_NAME }} -o"{{ .FIRST_FILE_NAME  | replace ".zip.001" "" }}"
      # - task: validate-downloaded-files
      - echo "validating"
      # - task: validate-downloaded-files
      #   silent: true
      - echo "Download completed"
  validate-downloaded-files:
    preconditions:
      - sh: test -f ./foo
        msg: "./foo not found."
      - sh: test -f ./bar
        msg: "./bar not found."
    
  parallel-download-task:
    deps:
      - for: 
          var: URLS
        task: download-task
        silent: true
        vars:
          URL: '{{.ITEM}}'

  download-task:
    vars:
      FILE_NAME:
        sh: curl --head --remote-name --write-out %{filename_effective} {{ .URL }}
    cmds:
      - echo "Downloading {{ .FILE_NAME }}"
      - curl --silent {{ .URL }} -L -J --output "{{ .FILE_NAME }}"
      
